# ScreenMonitor 截屏模块说明（中文）

本文档说明 ScreenMonitor 插件的“截屏”模块（WGC/GDI、显示器选择、调试日志、常见问题），用于二次开发与维护。

## 1. 模块目标

- 在 Windows 上周期性获取屏幕图像，供后续“视觉模型/内容分析”使用。
- 支持多显示器：用户可选择要截取哪一块屏幕。
- 在 Debug/排障场景下提供可定位问题的日志与诊断信息。

## 2. 主要文件

- 截屏核心：
  - `VPet-Simulator.Plugin.ScreenMonitor/CaptureHelper.cs`
- 调试日志：
  - `VPet-Simulator.Plugin.ScreenMonitor/DebugLogger.cs`
- 设置窗口（测试截屏/显示器选择/频率）：
  - `VPet-Simulator.Plugin.ScreenMonitor/winSettings.xaml`
  - `VPet-Simulator.Plugin.ScreenMonitor/winSettings.xaml.cs`
- 插件调度（定时器触发截屏、读取设置）：
  - `VPet-Simulator.Plugin.ScreenMonitor/ScreenMonitorPlugin.cs`

## 3. 截屏实现概览

### 3.1 首选方案：WGC（Windows Graphics Capture）

- 使用 WinRT 的 `Windows.Graphics.Capture` 抓取屏幕内容。
- 关键路径：
  1) 根据用户选择的显示器（`\\.\DISPLAY1` 这类 DeviceName）找到显示器 Bounds
  2) 通过 `MonitorFromPoint` 将 Bounds 映射到 `HMONITOR`
  3) 通过 COM 互操作 `IGraphicsCaptureItemInterop.CreateForMonitor` 创建 `GraphicsCaptureItem`
  4) 使用 `Direct3D11CaptureFramePool` 等待第一帧到来
  5) 将帧 surface 转为 `SoftwareBitmap`，编码为 JPEG（默认缩放到宽度 1024）

> 备注：`IGraphicsCaptureItemInterop` 的接口声明必须与系统一致；一旦 vtable/签名错位，可能出现 “HRESULT=0 但返回指针为 0” 的异常现象。

### 3.2 调试/兜底方案：GDI（仅在诊断路径回退）

- 在“测试截屏/诊断接口”中，如果 WGC 创建 item 或拿帧失败，会回退到 GDI。
- GDI 路径通过 `Graphics.CopyFromScreen(bounds.Left, bounds.Top, ...)` 仅截取所选显示器范围。

> 说明：目前插件的“定时监控主流程”使用 WGC 路径；GDI 回退主要用于测试/排障，避免功能完全不可用。

## 4. 多显示器选择

- 设置 UI 提供下拉框，展示每个显示器：DeviceName + 是否主屏 + 分辨率/坐标。
- 持久化设置键：
  - `MW.Set["screenmonitor"].monitor_device`（字符串，例如 `\\.\DISPLAY1`）

## 5. 调试日志

WPF 程序通常没有控制台窗口，因此日志默认落盘。

- 日志文件：`%TEMP%\vpet_screenmonitor_debug.log`
- 仅 Debug 版本会写入（通过 `[Conditional("DEBUG")]` 控制）。
- 日志内容包含：
  - 使用了 WGC 还是 GDI
  - 选中的显示器与解析到的 `HMONITOR`
  - `CreateForMonitor/CreateForWindow` 的 `HRESULT/ptr`
  - 是否成功拿到帧、是否超时、编码后的字节数等

## 6. 常见问题与排查

### 6.1 WGC 返回 hr=0 但 ptr=0

- 常见原因：COM interop 接口声明/vtable 对齐错误（签名不匹配）。
- 处理：检查 `IGraphicsCaptureItemInterop` 声明是否与示例一致（通常只包含 `CreateForWindow/CreateForMonitor`）。

### 6.2 WGC 创建 item 成功但一直拿不到帧（超时）

- 可能原因：系统隐私权限/策略限制、抓取目标不可捕获、或会话未能开始。
- 处理：使用设置里的“测试截屏”，查看诊断输出与日志文件。

## 7. 设置键一览

- `MW.Set["screenmonitor"].interval_ms`：监控频率（毫秒）
- `MW.Set["screenmonitor"].monitor_device`：目标显示器 DeviceName（例如 `\\.\DISPLAY1`）

