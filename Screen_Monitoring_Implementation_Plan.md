# 桌宠实时屏幕监控实现方案 (Screen Monitoring Implementation Plan)

## 1. 背景与目标
让桌宠能够“看见”用户的屏幕内容，从而实现更智能的互动。例如：
- 当用户在写代码时，桌宠可以给予鼓励或吐槽。
- 当用户在看视频时，桌宠可以分享感受。
- 当用户在玩游戏时，桌宠可以加油助威。

## 2. 核心技术方案

### 2.1 屏幕捕获：Windows Graphics Capture API (WinRT)
这是 Windows 10 (1803+) 引入的高性能捕获框架，相比传统的 GDI+ 或 DirectX 抓取，它具有以下优势：
- **高性能**: 直接在 GPU 内存中处理，极大地降低了 CPU 占用。
- **灵活性**: 支持捕获整个显示器或特定的单个窗口。
- **安全性**: 捕获时会有系统级的黄色边框提示（在较新版本 Windows 中可关闭），符合系统安全规范。
- **实现细节**: 
  - 需要在 C# 项目中引用 `Microsoft.Windows.SDK.Contracts` 以调用 WinRT API。
  - 使用 `GraphicsCapturePicker` 或 `CreateFromVisual` 初始化捕获。
  - 通过 `Direct3D11CaptureFramePool` 获取帧数据。

### 2.2 内容分析：多模态大模型 API (Multimodal LLM)
直接将捕获的图像发送至支持视觉能力的大模型（如 GPT-4o, Claude 3.5 Sonnet, 或兼容 OpenAI 格式的视觉模型接口）：
- **处理流程**:
  1. **图像压缩**: 将捕获的高清帧缩放至模型推荐的分辨率（如 768x768 或 1024x1024），并转换为 Base64 编码的 JPEG 格式。
  2. **上下文构建**: 结合当前活跃窗口标题、系统时间、桌宠状态等信息构建 Prompt。
  3. **异步请求**: 使用 `HttpClient` 发送异步请求，避免阻塞桌宠主线程。
- **优势**: 能够理解复杂的视觉语义，无需编写复杂的硬编码规则即可识别用户正在进行的操作。

### 2.3 插件化集成
- **插件入口**: 继承 `MainPlugin`，在 `LoadPlugin` 中注册监控逻辑。
- **交互接口**: 利用 `ITalkAPI` 或直接调用 `MW.Main.Say` 让桌宠说话。
- **配置管理**: 在插件设置界面允许用户配置 API Key、监控频率（如 30s 一次）以及捕获范围。

## 3. 详细设计

### 3.1 流程图
1. **触发**: 定时器触发（当前设为 10 秒）并检测到活动窗口变化。
2. **捕获**: 调用 `CaptureHelper` 使用 WinRT API 获取当前活动窗口截图。
3. **预处理**: 
   - 缩放至 1024 宽（保持比例）。
   - 转换为 JPEG 格式并进行 Base64 编码。
4. **分析**: 
   - 构建包含窗口标题和图像的 JSON 请求。
   - 发送至 `VisionAPIClient` 对接多模态模型。
5. **反馈**: 
   - AI 生成符合桌宠性格的短评。
   - 调用 `MW.Main.Say` 在桌宠气泡中显示。

### 3.2 Prompt 设计
为了让桌宠的表现更自然，Prompt 包含以下要素：
- **角色设定**: 明确桌宠的身份（可爱、毒舌、鼓励型等）。
- **上下文信息**: 提供当前活动窗口的标题，帮助模型理解应用场景。
- **输出限制**: 限制字数（如 30 字以内），确保气泡显示效果。
- **示例**: "你正在看 VS Code，是在写 Bug 还是在修 Bug 呀？加油哦！"

## 4. 开发计划 (Roadmap)
1. **Phase 1: 基础环境搭建**
   - 创建 VPet 插件项目，引入 WinRT 相关 SDK 引用。
   - 实现基础的活动窗口检测逻辑。
2. **Phase 2: 屏幕捕获模块实现**
   - 编写基于 `Windows.Graphics.Capture` 的截图工具类。
   - 实现图像的预处理（缩放、压缩、转 Base64）。
3. **Phase 3: AI 接口对接**
   - 集成多模态大模型 API（如 OpenAI Vision API）。
   - 设计针对屏幕内容的 Prompt 模板。
4. **Phase 4: 交互与优化**
   - 实现桌宠根据 AI 分析结果进行语音/文字反馈。
   - 增加隐私过滤（黑名单应用）和性能调优（动态调整监控频率）。

## 5. 总结
通过“屏幕捕获 + 视觉 AI”的方案，可以极大地提升桌宠的交互深度，使其从一个简单的动画挂件进化为真正的“桌面伴侣”。
